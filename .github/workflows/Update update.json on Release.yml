name: Update update.json on Release

on:
  release:
    types: [published]

jobs:
  update-json:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version and calculate versionCode
        id: parse
        run: |
          TAG=${{ github.event.release.tag_name }}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          # 提取纯数字：移除v，替换.为，如v1.8.0 → 180
          VERSION_CODE=$(echo "$TAG" | sed -E 's/v([0-9]+)\.([0-9]+)\.([0-9]+)/\1\2\3/')
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Update update.json
        run: |
          cat > update.json << EOF
{
  "version": "${{ steps.parse.outputs.tag }}",
  "versionCode": ${{ steps.parse.outputs.version_code }},
  "zipUrl": "${{ github.event.release.zipball_url }}",
  "changelog": "https://raw.githubusercontent.com/METEOR137/Flyme-icons/refs/heads/main/updatelog.json"
}
EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add update.json
          git commit -m "chore: update update.json for ${{ steps.parse.outputs.tag }}"
          git push
